"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.correlationMiddleware = correlationMiddleware;
exports.withCorrelation = withCorrelation;

var _uuid = require("uuid");

var _clsHooked = require("cls-hooked");

var namespace = (0, _clsHooked.createNamespace)('correlation');
/**
 * Creates a middleware function to extract a correlation ID from an incoming request or to create
 * a correlation ID if no such ID exists
 * 
 * @param header -  
 * @returns 
 */

function correlationMiddleware() {
  var header = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : 'x-correlation-id';
  return function (request, response, next) {
    var correlationId = request.headers[header];

    if (!correlationId) {
      correlationId = generateCorrelationId();
    }

    namespace.run(function () {
      namespace.set('correlationId', correlationId);
    });
    next();
  };
}

var generateCorrelationId = function generateCorrelationId() {
  return (0, _uuid.v4)();
};

function withCorrelation() {
  return namespace.get('correlationId');
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9jb3JyZWxhdGlvbk1pZGRsZXdhcmUudHMiXSwibmFtZXMiOlsibmFtZXNwYWNlIiwiY29ycmVsYXRpb25NaWRkbGV3YXJlIiwiaGVhZGVyIiwicmVxdWVzdCIsInJlc3BvbnNlIiwibmV4dCIsImNvcnJlbGF0aW9uSWQiLCJoZWFkZXJzIiwiZ2VuZXJhdGVDb3JyZWxhdGlvbklkIiwicnVuIiwic2V0Iiwid2l0aENvcnJlbGF0aW9uIiwiZ2V0Il0sIm1hcHBpbmdzIjoiOzs7Ozs7OztBQUNBOztBQUNBOztBQUVBLElBQU1BLFNBQVMsR0FBRyxnQ0FBZ0IsYUFBaEIsQ0FBbEI7QUFFQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTs7QUFDTyxTQUFTQyxxQkFBVCxHQUE0RDtBQUFBLE1BQTdCQyxNQUE2Qix1RUFBcEIsa0JBQW9CO0FBQy9ELFNBQU8sVUFBQ0MsT0FBRCxFQUFtQkMsUUFBbkIsRUFBdUNDLElBQXZDLEVBQThEO0FBQ2pFLFFBQUlDLGFBQWEsR0FBR0gsT0FBTyxDQUFDSSxPQUFSLENBQWdCTCxNQUFoQixDQUFwQjs7QUFDQSxRQUFJLENBQUNJLGFBQUwsRUFBb0I7QUFDaEJBLE1BQUFBLGFBQWEsR0FBR0UscUJBQXFCLEVBQXJDO0FBQ0g7O0FBQ0RSLElBQUFBLFNBQVMsQ0FBQ1MsR0FBVixDQUFjLFlBQU07QUFDaEJULE1BQUFBLFNBQVMsQ0FBQ1UsR0FBVixDQUFjLGVBQWQsRUFBK0JKLGFBQS9CO0FBQ0gsS0FGRDtBQUdBRCxJQUFBQSxJQUFJO0FBQ1AsR0FURDtBQVVIOztBQUVELElBQU1HLHFCQUFxQixHQUFHLFNBQXhCQSxxQkFBd0I7QUFBQSxTQUFNLGVBQU47QUFBQSxDQUE5Qjs7QUFFTyxTQUFTRyxlQUFULEdBQTJCO0FBQzlCLFNBQU9YLFNBQVMsQ0FBQ1ksR0FBVixDQUFjLGVBQWQsQ0FBUDtBQUNIIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgTmV4dEZ1bmN0aW9uLCBSZXF1ZXN0LCBSZXNwb25zZSB9IGZyb20gJ2V4cHJlc3MnO1xuaW1wb3J0IHsgdjQgYXMgdXVpZHY0IH0gZnJvbSAndXVpZCc7XG5pbXBvcnQgeyBjcmVhdGVOYW1lc3BhY2UgfSBmcm9tICdjbHMtaG9va2VkJztcblxuY29uc3QgbmFtZXNwYWNlID0gY3JlYXRlTmFtZXNwYWNlKCdjb3JyZWxhdGlvbicpO1xuXG4vKipcbiAqIENyZWF0ZXMgYSBtaWRkbGV3YXJlIGZ1bmN0aW9uIHRvIGV4dHJhY3QgYSBjb3JyZWxhdGlvbiBJRCBmcm9tIGFuIGluY29taW5nIHJlcXVlc3Qgb3IgdG8gY3JlYXRlXG4gKiBhIGNvcnJlbGF0aW9uIElEIGlmIG5vIHN1Y2ggSUQgZXhpc3RzXG4gKiBcbiAqIEBwYXJhbSBoZWFkZXIgLSAgXG4gKiBAcmV0dXJucyBcbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIGNvcnJlbGF0aW9uTWlkZGxld2FyZShoZWFkZXIgPSAneC1jb3JyZWxhdGlvbi1pZCcpIHtcbiAgICByZXR1cm4gKHJlcXVlc3Q6IFJlcXVlc3QsIHJlc3BvbnNlOiBSZXNwb25zZSwgbmV4dDogTmV4dEZ1bmN0aW9uKSA9PiB7XG4gICAgICAgIGxldCBjb3JyZWxhdGlvbklkID0gcmVxdWVzdC5oZWFkZXJzW2hlYWRlcl07XG4gICAgICAgIGlmICghY29ycmVsYXRpb25JZCkge1xuICAgICAgICAgICAgY29ycmVsYXRpb25JZCA9IGdlbmVyYXRlQ29ycmVsYXRpb25JZCgpO1xuICAgICAgICB9XG4gICAgICAgIG5hbWVzcGFjZS5ydW4oKCkgPT4ge1xuICAgICAgICAgICAgbmFtZXNwYWNlLnNldCgnY29ycmVsYXRpb25JZCcsIGNvcnJlbGF0aW9uSWQpO1xuICAgICAgICB9KTtcbiAgICAgICAgbmV4dCgpO1xuICAgIH1cbn1cblxuY29uc3QgZ2VuZXJhdGVDb3JyZWxhdGlvbklkID0gKCkgPT4gdXVpZHY0KCk7XG5cbmV4cG9ydCBmdW5jdGlvbiB3aXRoQ29ycmVsYXRpb24oKSB7XG4gICAgcmV0dXJuIG5hbWVzcGFjZS5nZXQoJ2NvcnJlbGF0aW9uSWQnKTtcbn0iXX0=