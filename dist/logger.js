"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.withLogger = void 0;

var _toConsumableArray2 = _interopRequireDefault(require("@babel/runtime/helpers/toConsumableArray"));

var _slicedToArray2 = _interopRequireDefault(require("@babel/runtime/helpers/slicedToArray"));

var _objectWithoutProperties2 = _interopRequireDefault(require("@babel/runtime/helpers/objectWithoutProperties"));

var _winstonEnricher = _interopRequireDefault(require("@newrelic/winston-enricher"));

var _winston = _interopRequireDefault(require("winston"));

var _correlationMiddleware = require("./correlation-middleware");

var _LogDeliveryAgent = require("./LogDeliveryAgent");

var _ref2, _process$env$LOG_LEVE;

var _excluded = ["level", "message", "label", "timestamp"];
// Queue for logs prior to logger creation
var logStyles = ['STRING_COLOR', 'STRING', 'JSON', 'SILENT', 'NEW_RELIC'];
var defaultLogStyle = logStyles[0];

var stdoutFormat = _winston["default"].format.printf(function (_ref) {
  var level = _ref.level,
      message = _ref.message,
      label = _ref.label,
      timestamp = _ref.timestamp,
      meta = (0, _objectWithoutProperties2["default"])(_ref, _excluded);

  if (message instanceof Object) {
    message = JSON.stringify(message);
  }

  var result = "".concat(timestamp, " [").concat(label, "] ").concat(level, ": ").concat(message);

  if (meta) {
    var metaJson = JSON.stringify(meta); // Don't write metadata if the JSON string was empty due to undefined values, eg: { correlationId: undefined }

    if (metaJson.length > 2) result += " ".concat(meta.correlationId, ": ").concat(metaJson);
  }

  return result;
});

var correlationIdFormat = _winston["default"].format(function (info) {
  info.correlationId = (0, _correlationMiddleware.withCorrelation)();
  return info;
});

var getNewRelicLogTransport = function getNewRelicLogTransport() {
  var _NewRelicLogDeliveryA;

  messages.push(['silly', 'Attempting retrieval of NewRelicLogDeliveryAgent instance']);

  var instance = _LogDeliveryAgent.NewRelicLogDeliveryAgent.getInstance();

  if (instance) {
    return instance.getLogTransport();
  }

  messages.push(['debug', 'No NewRelicLogDeliveryAgent defined, initializing instance']);
  var transport = (_NewRelicLogDeliveryA = _LogDeliveryAgent.NewRelicLogDeliveryAgent.initialize()) === null || _NewRelicLogDeliveryA === void 0 ? void 0 : _NewRelicLogDeliveryA.getLogTransport();
  transport === null || transport === void 0 ? void 0 : transport.setMaxListeners(Infinity);
  messages.push(['silly', "Transport created"]);
  return transport;
};

var getLogStyleOption = function getLogStyleOption() {
  if (!process.env.LOG_STYLE) {
    return [defaultLogStyle, "Using default log style: ".concat(defaultLogStyle, ". Override this using the LOG_STYLE environment variable. Valid values are: ").concat(logStyles, ".")];
  }

  if (logStyles.includes(process.env.LOG_STYLE.toUpperCase().trim())) {
    return [process.env.LOG_STYLE, "Using log style: ".concat(process.env.LOG_STYLE)];
  }

  return [defaultLogStyle, "Unrecognized log style: ".concat(process.env.LOG_STYLE, ". Using default log style: ").concat(defaultLogStyle, ". Valid log styles are: ").concat(logStyles)];
};

var defaultLoggingLevel = (_ref2 = (_process$env$LOG_LEVE = process.env.LOG_LEVEL) !== null && _process$env$LOG_LEVE !== void 0 ? _process$env$LOG_LEVE : process.env.LEVEL) !== null && _ref2 !== void 0 ? _ref2 : 'debug';
var messages = [];

var _getLogStyleOption = getLogStyleOption(),
    _getLogStyleOption2 = (0, _slicedToArray2["default"])(_getLogStyleOption, 2),
    logStyle = _getLogStyleOption2[0],
    message = _getLogStyleOption2[1];

messages.push(['info', message]);

var withLogger = function withLogger(label, level) {
  switch (logStyle) {
    case 'JSON':
      return createJsonLogger(label, level);

    case 'STRING':
      return createStringLogger(label, level);

    case 'STRING_COLOR':
      return createColorStringLogger(label, level);

    case 'SILENT':
      return createSilentLogger(label, level);

    case 'NEW_RELIC':
      return createNewRelicLogger(label, level);
  }
};

exports.withLogger = withLogger;

var createNewRelicLogger = function createNewRelicLogger(label, level) {
  var _winston$format;

  if (!process.env.NEW_RELIC_LICENSE_KEY) {
    messages.push(['warn', 'NEW_RELIC logging style configured but NEW_RELIC_LICENSE_KEY is not defined! Falling back to JSON logger.']);
    return createJsonLogger(label, level);
  }

  return _winston["default"].loggers.add(label, {
    level: level !== null && level !== void 0 ? level : defaultLoggingLevel,
    format: (_winston$format = _winston["default"].format).combine.apply(_winston$format, (0, _toConsumableArray2["default"])(defaultLoggers(label)).concat([(0, _winstonEnricher["default"])()])),
    transports: [getNewRelicLogTransport()]
  });
};

var createJsonLogger = function createJsonLogger(label, level) {
  var _winston$format2;

  return _winston["default"].loggers.add(label, {
    level: level !== null && level !== void 0 ? level : defaultLoggingLevel,
    format: (_winston$format2 = _winston["default"].format).combine.apply(_winston$format2, (0, _toConsumableArray2["default"])(defaultLoggers(label)).concat([(0, _winstonEnricher["default"])()])),
    transports: [new _winston["default"].transports.Console()]
  });
};

var createStringLogger = function createStringLogger(label, level) {
  var _winston$format3;

  return _winston["default"].loggers.add(label, {
    level: level !== null && level !== void 0 ? level : defaultLoggingLevel,
    format: (_winston$format3 = _winston["default"].format).combine.apply(_winston$format3, (0, _toConsumableArray2["default"])(defaultLoggers(label)).concat([stdoutFormat])),
    transports: [new _winston["default"].transports.Console()]
  });
};

var createColorStringLogger = function createColorStringLogger(label, level) {
  var _winston$format4;

  return _winston["default"].loggers.add(label, {
    level: level !== null && level !== void 0 ? level : defaultLoggingLevel,
    format: (_winston$format4 = _winston["default"].format).combine.apply(_winston$format4, (0, _toConsumableArray2["default"])(defaultLoggers(label)).concat([_winston["default"].format.colorize(), stdoutFormat])),
    transports: [new _winston["default"].transports.Console()]
  });
};

var createSilentLogger = function createSilentLogger(label, level) {
  return _winston["default"].loggers.add(label, {
    silent: true,
    level: level !== null && level !== void 0 ? level : defaultLoggingLevel,
    transports: [new _winston["default"].transports.Console()]
  });
};

var defaultLoggers = function defaultLoggers(label) {
  return [correlationIdFormat(), _winston["default"].format.label({
    label: label
  }), _winston["default"].format.timestamp(), _winston["default"].format.splat()];
};

var log = withLogger('logger');
messages.push(['debug', 'Internal logger initialized']);

while (messages.length > 0) {
  var _ref3 = messages.shift(),
      _ref4 = (0, _slicedToArray2["default"])(_ref3, 2),
      level = _ref4[0],
      _message = _ref4[1];

  log[level](_message);
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9sb2dnZXIudHMiXSwibmFtZXMiOlsibG9nU3R5bGVzIiwiZGVmYXVsdExvZ1N0eWxlIiwic3Rkb3V0Rm9ybWF0Iiwid2luc3RvbiIsImZvcm1hdCIsInByaW50ZiIsImxldmVsIiwibWVzc2FnZSIsImxhYmVsIiwidGltZXN0YW1wIiwibWV0YSIsIk9iamVjdCIsIkpTT04iLCJzdHJpbmdpZnkiLCJyZXN1bHQiLCJtZXRhSnNvbiIsImxlbmd0aCIsImNvcnJlbGF0aW9uSWQiLCJjb3JyZWxhdGlvbklkRm9ybWF0IiwiaW5mbyIsImdldE5ld1JlbGljTG9nVHJhbnNwb3J0IiwibWVzc2FnZXMiLCJwdXNoIiwiaW5zdGFuY2UiLCJOZXdSZWxpY0xvZ0RlbGl2ZXJ5QWdlbnQiLCJnZXRJbnN0YW5jZSIsImdldExvZ1RyYW5zcG9ydCIsInRyYW5zcG9ydCIsImluaXRpYWxpemUiLCJzZXRNYXhMaXN0ZW5lcnMiLCJJbmZpbml0eSIsImdldExvZ1N0eWxlT3B0aW9uIiwicHJvY2VzcyIsImVudiIsIkxPR19TVFlMRSIsImluY2x1ZGVzIiwidG9VcHBlckNhc2UiLCJ0cmltIiwiZGVmYXVsdExvZ2dpbmdMZXZlbCIsIkxPR19MRVZFTCIsIkxFVkVMIiwibG9nU3R5bGUiLCJ3aXRoTG9nZ2VyIiwiY3JlYXRlSnNvbkxvZ2dlciIsImNyZWF0ZVN0cmluZ0xvZ2dlciIsImNyZWF0ZUNvbG9yU3RyaW5nTG9nZ2VyIiwiY3JlYXRlU2lsZW50TG9nZ2VyIiwiY3JlYXRlTmV3UmVsaWNMb2dnZXIiLCJORVdfUkVMSUNfTElDRU5TRV9LRVkiLCJsb2dnZXJzIiwiYWRkIiwiY29tYmluZSIsImRlZmF1bHRMb2dnZXJzIiwidHJhbnNwb3J0cyIsIkNvbnNvbGUiLCJjb2xvcml6ZSIsInNpbGVudCIsInNwbGF0IiwibG9nIiwic2hpZnQiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7OztBQUNBOztBQUNBOztBQUNBOztBQUVBOzs7OztBQU1BO0FBQ0EsSUFBTUEs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OztBQVdBLElBQU1GLGNBQWMsR0FBRyxTQUFqQkEsY0FBaUIsQ0FBQzVDLEtBQUQ7QUFBQSxTQUE2QyxDQUNoRVUsbUJBQW1CLEVBRDZDLEVBRWhFZixvQkFBUUMsTUFBUixDQUFlSSxLQUFmLENBQXFCO0FBQUVBLElBQUFBLEtBQUssRUFBTEE7QUFBRixHQUFyQixDQUZnRSxFQUdoRUwsb0JBQVFDLE1BQVIsQ0FBZUssU0FBZixFQUhnRSxFQUloRU4sb0JBQVFDLE1BQVIsQ0FBZXFELEtBQWYsRUFKZ0UsQ0FBN0M7QUFBQSxDQUF2Qjs7QUFPQSxJQUFNQyxHQUFHLEdBQUdoQixVQUFVLENBQUMsUUFBRCxDQUF0QjtBQUNBckIsUUFBUSxDQUFDQyxJQUFULENBQWMsQ0FBQyxPQUFELEVBQVUsNkJBQVYsQ0FBZDs7QUFDQSxPQUFNRCxRQUFRLENBQUNMLE1BQVQsR0FBa0IsQ0FBeEIsRUFBMkI7QUFDdkIsY0FBeUJLLFFBQVEsQ0FBQ3NDLEtBQVQsRUFBekI7QUFBQTtBQUFBLE1BQU9yRCxLQUFQO0FBQUEsTUFBY0MsUUFBZDs7QUFDQW1ELEVBQUFBLEdBQUcsQ0FBQ3BELEtBQUQsQ0FBSCxDQUFXQyxRQUFYO0FBQ0giLCJzb3VyY2VzQ29udGVudCI6WyIvLyBAdHMtaWdub3JlXG5pbXBvcnQgbmV3cmVsaWNGb3JtYXR0ZXIgZnJvbSAnQG5ld3JlbGljL3dpbnN0b24tZW5yaWNoZXInO1xuaW1wb3J0IHdpbnN0b24sIHsgTG9nZ2VyIH0gZnJvbSAnd2luc3Rvbic7XG5pbXBvcnQgeyB3aXRoQ29ycmVsYXRpb24gfSBmcm9tICcuL2NvcnJlbGF0aW9uLW1pZGRsZXdhcmUnO1xuaW1wb3J0IHsgTmV3UmVsaWNMb2dUcmFuc3BvcnQgfSBmcm9tICcuL05ld1JlbGljTG9nVHJhbnNwb3J0JztcbmltcG9ydCB7IE5ld1JlbGljTG9nRGVsaXZlcnlBZ2VudCB9IGZyb20gJy4vTG9nRGVsaXZlcnlBZ2VudCc7XG5cbmV4cG9ydCB0eXBlIEtMTG9nZ2VyID0gd2luc3Rvbi5Mb2dnZXJcbmV4cG9ydCB0eXBlIE5QTUxvZ2dpbmdMZXZlbHMgPSAnc2lsbHknIHwgJ2RlYnVnJyB8ICd2ZXJib3NlJyB8ICdodHRwJyB8ICdpbmZvJyB8ICd3YXJuJyB8ICdlcnJvcic7XG50eXBlIExvZ1N0eWxlID0gJ1NUUklOR19DT0xPUicgfCAnU1RSSU5HJyB8ICdKU09OJyB8ICdTSUxFTlQnIHwgJ05FV19SRUxJQyc7XG5cbi8vIFF1ZXVlIGZvciBsb2dzIHByaW9yIHRvIGxvZ2dlciBjcmVhdGlvblxuY29uc3QgbG9nU3R5bGVzOiBMb2dTdHlsZVtdID0gWydTVFJJTkdfQ09MT1InLCAnU1RSSU5HJywgJ0pTT04nLCAnU0lMRU5UJywgJ05FV19SRUxJQyddO1xuY29uc3QgZGVmYXVsdExvZ1N0eWxlOiBMb2dTdHlsZSA9IGxvZ1N0eWxlc1swXTtcblxuY29uc3Qgc3Rkb3V0Rm9ybWF0ID0gd2luc3Rvbi5mb3JtYXQucHJpbnRmKCh7IGxldmVsLCBtZXNzYWdlLCBsYWJlbCwgdGltZXN0YW1wLCAuLi5tZXRhIH0pID0+IHtcbiAgICBpZiAobWVzc2FnZSBhcyBhbnkgaW5zdGFuY2VvZiBPYmplY3QpIHtcbiAgICAgICAgbWVzc2FnZSA9IEpTT04uc3RyaW5naWZ5KG1lc3NhZ2UpO1xuICAgIH1cbiAgICBsZXQgcmVzdWx0ID0gYCR7dGltZXN0YW1wfSBbJHtsYWJlbH1dICR7bGV2ZWx9OiAke21lc3NhZ2V9YFxuICAgIGlmIChtZXRhKSB7XG4gICAgICAgIGNvbnN0IG1ldGFKc29uID0gSlNPTi5zdHJpbmdpZnkobWV0YSk7XG5cbiAgICAgICAgLy8gRG9uJ3Qgd3JpdGUgbWV0YWRhdGEgaWYgdGhlIEpTT04gc3RyaW5nIHdhcyBlbXB0eSBkdWUgdG8gdW5kZWZpbmVkIHZhbHVlcywgZWc6IHsgY29ycmVsYXRpb25JZDogdW5kZWZpbmVkIH1cbiAgICAgICAgaWYgKG1ldGFKc29uLmxlbmd0aCA+IDIpIFxuICAgICAgICAgICAgcmVzdWx0ICs9IGAgJHttZXRhLmNvcnJlbGF0aW9uSWR9OiAke21ldGFKc29ufWBcbiAgICB9XG4gICAgcmV0dXJuIHJlc3VsdFxufSk7XG5cbmNvbnN0IGNvcnJlbGF0aW9uSWRGb3JtYXQgPSB3aW5zdG9uLmZvcm1hdChpbmZvID0+IHtcbiAgICBpbmZvLmNvcnJlbGF0aW9uSWQgPSB3aXRoQ29ycmVsYXRpb24oKTtcbiAgICByZXR1cm4gaW5mbztcbn0pO1xuXG5jb25zdCBnZXROZXdSZWxpY0xvZ1RyYW5zcG9ydDogKCkgPT4gTmV3UmVsaWNMb2dUcmFuc3BvcnQgfCB1bmRlZmluZWQgPSAoKSA9PiB7XG4gICAgbWVzc2FnZXMucHVzaChbJ3NpbGx5JywgJ0F0dGVtcHRpbmcgcmV0cmlldmFsIG9mIE5ld1JlbGljTG9nRGVsaXZlcnlBZ2VudCBpbnN0YW5jZSddKTtcbiAgICBsZXQgaW5zdGFuY2UgPSBOZXdSZWxpY0xvZ0RlbGl2ZXJ5QWdlbnQuZ2V0SW5zdGFuY2UoKTtcbiAgICBpZiAoaW5zdGFuY2UpIHtcbiAgICAgICAgcmV0dXJuIGluc3RhbmNlLmdldExvZ1RyYW5zcG9ydCgpO1xuICAgIH1cbiAgICBtZXNzYWdlcy5wdXNoKFsnZGVidWcnLCAnTm8gTmV3UmVsaWNMb2dEZWxpdmVyeUFnZW50IGRlZmluZWQsIGluaXRpYWxpemluZyBpbnN0YW5jZSddKTtcbiAgICBjb25zdCB0cmFuc3BvcnQgPSBOZXdSZWxpY0xvZ0RlbGl2ZXJ5QWdlbnQuaW5pdGlhbGl6ZSgpPy5nZXRMb2dUcmFuc3BvcnQoKTtcbiAgICB0cmFuc3BvcnQ/LnNldE1heExpc3RlbmVycyhJbmZpbml0eSk7XG4gICAgbWVzc2FnZXMucHVzaChbJ3NpbGx5JywgYFRyYW5zcG9ydCBjcmVhdGVkYF0pO1xuICAgIHJldHVybiB0cmFuc3BvcnQ7XG59XG5cbmNvbnN0IGdldExvZ1N0eWxlT3B0aW9uID0gKCk6IFtMb2dTdHlsZSwgc3RyaW5nXSA9PiB7XG4gICAgaWYgKCFwcm9jZXNzLmVudi5MT0dfU1RZTEUpIHtcbiAgICAgICAgcmV0dXJuIFtcbiAgICAgICAgICAgIGRlZmF1bHRMb2dTdHlsZSxcbiAgICAgICAgICAgIGBVc2luZyBkZWZhdWx0IGxvZyBzdHlsZTogJHtkZWZhdWx0TG9nU3R5bGV9LiBPdmVycmlkZSB0aGlzIHVzaW5nIHRoZSBMT0dfU1RZTEUgZW52aXJvbm1lbnQgdmFyaWFibGUuIFZhbGlkIHZhbHVlcyBhcmU6ICR7bG9nU3R5bGVzfS5gXVxuICAgIH1cblxuICAgIGlmIChsb2dTdHlsZXMuaW5jbHVkZXMocHJvY2Vzcy5lbnYuTE9HX1NUWUxFLnRvVXBwZXJDYXNlKCkudHJpbSgpIGFzIExvZ1N0eWxlKSkge1xuICAgICAgICByZXR1cm4gW1xuICAgICAgICAgICAgcHJvY2Vzcy5lbnYuTE9HX1NUWUxFIGFzIExvZ1N0eWxlLFxuICAgICAgICAgICAgYFVzaW5nIGxvZyBzdHlsZTogJHtwcm9jZXNzLmVudi5MT0dfU1RZTEV9YFxuICAgICAgICBdO1xuICAgIH1cblxuICAgIHJldHVybiBbXG4gICAgICAgIGRlZmF1bHRMb2dTdHlsZSxcbiAgICAgICAgYFVucmVjb2duaXplZCBsb2cgc3R5bGU6ICR7cHJvY2Vzcy5lbnYuTE9HX1NUWUxFfS4gVXNpbmcgZGVmYXVsdCBsb2cgc3R5bGU6ICR7ZGVmYXVsdExvZ1N0eWxlfS4gVmFsaWQgbG9nIHN0eWxlcyBhcmU6ICR7bG9nU3R5bGVzfWBcbiAgICBdXG59XG5cbmNvbnN0IGRlZmF1bHRMb2dnaW5nTGV2ZWwgPSBwcm9jZXNzLmVudi5MT0dfTEVWRUwgPz8gcHJvY2Vzcy5lbnYuTEVWRUwgPz8gJ2RlYnVnJztcbmNvbnN0IG1lc3NhZ2VzOiBbTlBNTG9nZ2luZ0xldmVscywgc3RyaW5nXVtdID0gW107XG5jb25zdCBbbG9nU3R5bGUsIG1lc3NhZ2VdID0gZ2V0TG9nU3R5bGVPcHRpb24oKTtcbm1lc3NhZ2VzLnB1c2goWydpbmZvJywgbWVzc2FnZV0pO1xuZXhwb3J0IGNvbnN0IHdpdGhMb2dnZXIgPSAobGFiZWw6IHN0cmluZywgbGV2ZWw/OiBOUE1Mb2dnaW5nTGV2ZWxzKTogS0xMb2dnZXIgPT4ge1xuICAgIHN3aXRjaChsb2dTdHlsZSkge1xuICAgICAgICBjYXNlICdKU09OJzogICAgICAgICAgICByZXR1cm4gY3JlYXRlSnNvbkxvZ2dlcihsYWJlbCwgbGV2ZWwpO1xuICAgICAgICBjYXNlICdTVFJJTkcnOiAgICAgICAgICByZXR1cm4gY3JlYXRlU3RyaW5nTG9nZ2VyKGxhYmVsLCBsZXZlbCk7XG4gICAgICAgIGNhc2UgJ1NUUklOR19DT0xPUic6ICAgIHJldHVybiBjcmVhdGVDb2xvclN0cmluZ0xvZ2dlcihsYWJlbCwgbGV2ZWwpO1xuICAgICAgICBjYXNlICdTSUxFTlQnOiAgICAgICAgICByZXR1cm4gY3JlYXRlU2lsZW50TG9nZ2VyKGxhYmVsLCBsZXZlbCk7XG4gICAgICAgIGNhc2UgJ05FV19SRUxJQyc6ICAgICAgIHJldHVybiBjcmVhdGVOZXdSZWxpY0xvZ2dlcihsYWJlbCwgbGV2ZWwpO1xuICAgIH1cbn1cblxuY29uc3QgY3JlYXRlTmV3UmVsaWNMb2dnZXIgPSAobGFiZWw6IHN0cmluZywgbGV2ZWw/OiBOUE1Mb2dnaW5nTGV2ZWxzKSA9PiB7XG4gICAgaWYgKCFwcm9jZXNzLmVudi5ORVdfUkVMSUNfTElDRU5TRV9LRVkpIHtcbiAgICAgICAgbWVzc2FnZXMucHVzaChbJ3dhcm4nLCAnTkVXX1JFTElDIGxvZ2dpbmcgc3R5bGUgY29uZmlndXJlZCBidXQgTkVXX1JFTElDX0xJQ0VOU0VfS0VZIGlzIG5vdCBkZWZpbmVkISBGYWxsaW5nIGJhY2sgdG8gSlNPTiBsb2dnZXIuJ10pO1xuICAgICAgICByZXR1cm4gY3JlYXRlSnNvbkxvZ2dlcihsYWJlbCxsZXZlbCk7XG4gICAgfVxuXG4gICAgcmV0dXJuIHdpbnN0b24ubG9nZ2Vycy5hZGQobGFiZWwsIHtcbiAgICAgICAgbGV2ZWw6IGxldmVsID8/IGRlZmF1bHRMb2dnaW5nTGV2ZWwsXG4gICAgICAgIGZvcm1hdDogd2luc3Rvbi5mb3JtYXQuY29tYmluZShcbiAgICAgICAgICAgIC4uLmRlZmF1bHRMb2dnZXJzKGxhYmVsKSxcbiAgICAgICAgICAgIG5ld3JlbGljRm9ybWF0dGVyKClcbiAgICAgICAgKSxcbiAgICAgICAgdHJhbnNwb3J0czogWyBnZXROZXdSZWxpY0xvZ1RyYW5zcG9ydCgpIGFzIHdpbnN0b24udHJhbnNwb3J0IF1cbiAgICB9KTtcbn1cblxuXG5jb25zdCBjcmVhdGVKc29uTG9nZ2VyID0gKGxhYmVsOiBzdHJpbmcsIGxldmVsPzogTlBNTG9nZ2luZ0xldmVscykgPT4ge1xuICAgIFxuICAgIHJldHVybiB3aW5zdG9uLmxvZ2dlcnMuYWRkKGxhYmVsLCB7XG4gICAgICAgIGxldmVsOiBsZXZlbCA/PyBkZWZhdWx0TG9nZ2luZ0xldmVsLFxuICAgICAgICBmb3JtYXQ6IHdpbnN0b24uZm9ybWF0LmNvbWJpbmUoXG4gICAgICAgICAgICAuLi5kZWZhdWx0TG9nZ2VycyhsYWJlbCksXG4gICAgICAgICAgICBuZXdyZWxpY0Zvcm1hdHRlcigpXG4gICAgICAgICksXG4gICAgICAgIHRyYW5zcG9ydHM6IFsgbmV3IHdpbnN0b24udHJhbnNwb3J0cy5Db25zb2xlKCkgXVxuICAgIH0pO1xufVxuXG5jb25zdCBjcmVhdGVTdHJpbmdMb2dnZXIgPSAobGFiZWw6IHN0cmluZywgbGV2ZWw/OiBOUE1Mb2dnaW5nTGV2ZWxzKSA9PiB7XG4gICAgcmV0dXJuIHdpbnN0b24ubG9nZ2Vycy5hZGQobGFiZWwsIHtcbiAgICAgICAgbGV2ZWw6IGxldmVsID8/IGRlZmF1bHRMb2dnaW5nTGV2ZWwsXG4gICAgICAgIGZvcm1hdDogd2luc3Rvbi5mb3JtYXQuY29tYmluZShcbiAgICAgICAgICAgIC4uLmRlZmF1bHRMb2dnZXJzKGxhYmVsKSxcbiAgICAgICAgICAgIHN0ZG91dEZvcm1hdFxuICAgICAgICApLFxuICAgICAgICB0cmFuc3BvcnRzOiBbXG4gICAgICAgICAgICBuZXcgd2luc3Rvbi50cmFuc3BvcnRzLkNvbnNvbGUoKVxuICAgICAgICBdXG4gICAgfSk7XG59XG5cbmNvbnN0IGNyZWF0ZUNvbG9yU3RyaW5nTG9nZ2VyID0gKGxhYmVsOiBzdHJpbmcsIGxldmVsPzogTlBNTG9nZ2luZ0xldmVscykgPT4ge1xuICAgIHJldHVybiB3aW5zdG9uLmxvZ2dlcnMuYWRkKGxhYmVsLCB7XG4gICAgICAgIGxldmVsOiBsZXZlbCA/PyBkZWZhdWx0TG9nZ2luZ0xldmVsLFxuICAgICAgICBmb3JtYXQ6IHdpbnN0b24uZm9ybWF0LmNvbWJpbmUoXG4gICAgICAgICAgICAuLi5kZWZhdWx0TG9nZ2VycyhsYWJlbCksXG4gICAgICAgICAgICB3aW5zdG9uLmZvcm1hdC5jb2xvcml6ZSgpLFxuICAgICAgICAgICAgc3Rkb3V0Rm9ybWF0XG4gICAgICAgICksXG4gICAgICAgIHRyYW5zcG9ydHM6IFtcbiAgICAgICAgICAgIG5ldyB3aW5zdG9uLnRyYW5zcG9ydHMuQ29uc29sZSgpXG4gICAgICAgIF1cbiAgICB9KTtcbn1cblxuY29uc3QgY3JlYXRlU2lsZW50TG9nZ2VyID0gKGxhYmVsOiBzdHJpbmcsIGxldmVsPzogTlBNTG9nZ2luZ0xldmVscykgPT4ge1xuICAgIHJldHVybiB3aW5zdG9uLmxvZ2dlcnMuYWRkKGxhYmVsLCB7XG4gICAgICAgIHNpbGVudDogdHJ1ZSxcbiAgICAgICAgbGV2ZWw6IGxldmVsID8/IGRlZmF1bHRMb2dnaW5nTGV2ZWwsXG4gICAgICAgIHRyYW5zcG9ydHM6IFtcbiAgICAgICAgICAgIG5ldyB3aW5zdG9uLnRyYW5zcG9ydHMuQ29uc29sZSgpXG4gICAgICAgIF1cbiAgICB9KTtcbn1cblxuXG5jb25zdCBkZWZhdWx0TG9nZ2VycyA9IChsYWJlbDogc3RyaW5nKTogd2luc3Rvbi5Mb2dmb3JtLkZvcm1hdFtdID0+IFtcbiAgICBjb3JyZWxhdGlvbklkRm9ybWF0KCksXG4gICAgd2luc3Rvbi5mb3JtYXQubGFiZWwoeyBsYWJlbCB9KSxcbiAgICB3aW5zdG9uLmZvcm1hdC50aW1lc3RhbXAoKSxcbiAgICB3aW5zdG9uLmZvcm1hdC5zcGxhdCgpLFxuXSBcblxuY29uc3QgbG9nID0gd2l0aExvZ2dlcignbG9nZ2VyJyk7XG5tZXNzYWdlcy5wdXNoKFsnZGVidWcnLCAnSW50ZXJuYWwgbG9nZ2VyIGluaXRpYWxpemVkJ10pO1xud2hpbGUobWVzc2FnZXMubGVuZ3RoID4gMCkge1xuICAgIGNvbnN0IFtsZXZlbCwgbWVzc2FnZV0gPSBtZXNzYWdlcy5zaGlmdCgpIGFzIFtOUE1Mb2dnaW5nTGV2ZWxzLCBzdHJpbmddO1xuICAgIGxvZ1tsZXZlbF0obWVzc2FnZSk7XG59XG4iXX0=