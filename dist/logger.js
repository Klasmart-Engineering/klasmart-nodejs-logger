"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.withLogger = void 0;

var _toConsumableArray2 = _interopRequireDefault(require("@babel/runtime/helpers/toConsumableArray"));

var _slicedToArray2 = _interopRequireDefault(require("@babel/runtime/helpers/slicedToArray"));

var _winstonEnricher = _interopRequireDefault(require("@newrelic/winston-enricher"));

var _winston = _interopRequireDefault(require("winston"));

var _correlationMiddleware = require("./correlation-middleware");

var _LogDeliveryAgent = require("./LogDeliveryAgent");

var _ref2, _process$env$LOG_LEVE;

// Queue for logs prior to logger creation
var logStyles = ['STRING_COLOR', 'STRING', 'JSON', 'SILENT', 'NEW_RELIC'];
var defaultLogStyle = logStyles[0];

var stdoutFormat = _winston["default"].format.printf(function (_ref) {
  var level = _ref.level,
      message = _ref.message,
      label = _ref.label,
      timestamp = _ref.timestamp;
  return "".concat(timestamp, " [").concat(label, "] ").concat(level, ": ").concat(message);
});

var correlationIdFormat = _winston["default"].format(function (info) {
  info.correlationId = (0, _correlationMiddleware.withCorrelation)();
  return info;
});

var getNewRelicLogTransport = function getNewRelicLogTransport() {
  var _NewRelicLogDeliveryA;

  messages.push(['silly', 'Attempting retrieval of NewRelicLogDeliveryAgent instance']);

  var instance = _LogDeliveryAgent.NewRelicLogDeliveryAgent.getInstance();

  if (instance) {
    return instance.getLogTransport();
  }

  messages.push(['debug', 'No NewRelicLogDeliveryAgent defined, initializing instance']);
  var transport = (_NewRelicLogDeliveryA = _LogDeliveryAgent.NewRelicLogDeliveryAgent.initialize()) === null || _NewRelicLogDeliveryA === void 0 ? void 0 : _NewRelicLogDeliveryA.getLogTransport();
  transport === null || transport === void 0 ? void 0 : transport.setMaxListeners(Infinity);
  messages.push(['silly', "Transport created"]);
  return transport;
};

var getLogStyleOption = function getLogStyleOption() {
  if (!process.env.LOG_STYLE) {
    return [defaultLogStyle, "Using default log style: ".concat(defaultLogStyle, ". Override this using the LOG_STYLE environment variable. Valid values are: ").concat(logStyles, ".")];
  }

  if (logStyles.includes(process.env.LOG_STYLE.toUpperCase().trim())) {
    return [process.env.LOG_STYLE, "Using log style: ".concat(process.env.LOG_STYLE)];
  }

  return [defaultLogStyle, "Unrecognized log style: ".concat(process.env.LOG_STYLE, ". Using default log style: ").concat(defaultLogStyle, ". Valid log styles are: ").concat(logStyles)];
};

var defaultLoggingLevel = (_ref2 = (_process$env$LOG_LEVE = process.env.LOG_LEVEL) !== null && _process$env$LOG_LEVE !== void 0 ? _process$env$LOG_LEVE : process.env.LEVEL) !== null && _ref2 !== void 0 ? _ref2 : 'debug';
var messages = [];

var _getLogStyleOption = getLogStyleOption(),
    _getLogStyleOption2 = (0, _slicedToArray2["default"])(_getLogStyleOption, 2),
    logStyle = _getLogStyleOption2[0],
    message = _getLogStyleOption2[1];

messages.push(['info', message]);

var withLogger = function withLogger(label, level) {
  switch (logStyle) {
    case 'JSON':
      return createJsonLogger(label, level);

    case 'STRING':
      return createStringLogger(label, level);

    case 'STRING_COLOR':
      return createColorStringLogger(label, level);

    case 'SILENT':
      return createSilentLogger(label, level);

    case 'NEW_RELIC':
      return createNewRelicLogger(label, level);
  }
};

exports.withLogger = withLogger;

var createNewRelicLogger = function createNewRelicLogger(label, level) {
  var _winston$format;

  if (!process.env.NEW_RELIC_LICENSE_KEY) {
    messages.push(['warn', 'NEW_RELIC logging style configured but NEW_RELIC_LICENSE_KEY is not defined! Falling back to JSON logger.']);
    return createJsonLogger(label, level);
  }

  return _winston["default"].loggers.add(label, {
    level: level !== null && level !== void 0 ? level : defaultLoggingLevel,
    format: (_winston$format = _winston["default"].format).combine.apply(_winston$format, (0, _toConsumableArray2["default"])(defaultLoggers(label)).concat([(0, _winstonEnricher["default"])()])),
    transports: [getNewRelicLogTransport()]
  });
};

var createJsonLogger = function createJsonLogger(label, level) {
  var _winston$format2;

  return _winston["default"].loggers.add(label, {
    level: level !== null && level !== void 0 ? level : defaultLoggingLevel,
    format: (_winston$format2 = _winston["default"].format).combine.apply(_winston$format2, (0, _toConsumableArray2["default"])(defaultLoggers(label)).concat([(0, _winstonEnricher["default"])()])),
    transports: [new _winston["default"].transports.Console()]
  });
};

var createStringLogger = function createStringLogger(label, level) {
  var _winston$format3;

  return _winston["default"].loggers.add(label, {
    level: level !== null && level !== void 0 ? level : defaultLoggingLevel,
    format: (_winston$format3 = _winston["default"].format).combine.apply(_winston$format3, (0, _toConsumableArray2["default"])(defaultLoggers(label)).concat([stdoutFormat])),
    transports: [new _winston["default"].transports.Console()]
  });
};

var createColorStringLogger = function createColorStringLogger(label, level) {
  var _winston$format4;

  return _winston["default"].loggers.add(label, {
    level: level !== null && level !== void 0 ? level : defaultLoggingLevel,
    format: (_winston$format4 = _winston["default"].format).combine.apply(_winston$format4, (0, _toConsumableArray2["default"])(defaultLoggers(label)).concat([_winston["default"].format.colorize(), stdoutFormat])),
    transports: [new _winston["default"].transports.Console()]
  });
};

var createSilentLogger = function createSilentLogger(label, level) {
  return _winston["default"].loggers.add(label, {
    silent: true,
    level: level !== null && level !== void 0 ? level : defaultLoggingLevel,
    transports: [new _winston["default"].transports.Console()]
  });
};

var defaultLoggers = function defaultLoggers(label) {
  return [correlationIdFormat(), _winston["default"].format.label({
    label: label
  }), _winston["default"].format.timestamp(), _winston["default"].format.splat()];
};

var log = withLogger('logger');
messages.push(['debug', 'Internal logger initialized']);

while (messages.length > 0) {
  var _ref3 = messages.shift(),
      _ref4 = (0, _slicedToArray2["default"])(_ref3, 2),
      level = _ref4[0],
      _message = _ref4[1];

  log[level](_message);
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9sb2dnZXIudHMiXSwibmFtZXMiOlsibG9nU3R5bGVzIiwiZGVmYXVsdExvZ1N0eWxlIiwic3Rkb3V0Rm9ybWF0Iiwid2luc3RvbiIsImZvcm1hdCIsInByaW50ZiIsImxldmVsIiwibWVzc2FnZSIsImxhYmVsIiwidGltZXN0YW1wIiwiY29ycmVsYXRpb25JZEZvcm1hdCIsImluZm8iLCJjb3JyZWxhdGlvbklkIiwiZ2V0TmV3UmVsaWNMb2dUcmFuc3BvcnQiLCJtZXNzYWdlcyIsInB1c2giLCJpbnN0YW5jZSIsIk5ld1JlbGljTG9nRGVsaXZlcnlBZ2VudCIsImdldEluc3RhbmNlIiwiZ2V0TG9nVHJhbnNwb3J0IiwidHJhbnNwb3J0IiwiaW5pdGlhbGl6ZSIsInNldE1heExpc3RlbmVycyIsIkluZmluaXR5IiwiZ2V0TG9nU3R5bGVPcHRpb24iLCJwcm9jZXNzIiwiZW52IiwiTE9HX1NUWUxFIiwiaW5jbHVkZXMiLCJ0b1VwcGVyQ2FzZSIsInRyaW0iLCJkZWZhdWx0TG9nZ2luZ0xldmVsIiwiTE9HX0xFVkVMIiwiTEVWRUwiLCJsb2dTdHlsZSIsIndpdGhMb2dnZXIiLCJjcmVhdGVKc29uTG9nZ2VyIiwiY3JlYXRlU3RyaW5nTG9nZ2VyIiwiY3JlYXRlQ29sb3JTdHJpbmdMb2dnZXIiLCJjcmVhdGVTaWxlbnRMb2dnZXIiLCJjcmVhdGVOZXdSZWxpY0xvZ2dlciIsIk5FV19SRUxJQ19MSUNFTlNFX0tFWSIsImxvZ2dlcnMiLCJhZGQiLCJjb21iaW5lIiwiZGVmYXVsdExvZ2dlcnMiLCJ0cmFuc3BvcnRzIiwiQ29uc29sZSIsImNvbG9yaXplIiwic2lsZW50Iiwic3BsYXQiLCJsb2ciLCJsZW5ndGgiLCJzaGlmdCJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7OztBQUNBOztBQUNBOztBQUNBOztBQUVBOzs7O0FBTUE7QUFDQSxJQUFNQSxTQUFxQixHQUFHLENBQUMsY0FBRCxFQUFpQixRQUFqQixFQUEyQixNQUEzQixFQUFtQyxRQUFuQyxF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QTJCO0FBQ3ZCLGNBQXlCdEMsUUFBUSxDQUFDdUMsS0FBVCxFQUF6QjtBQUFBO0FBQUEsTUFBTy9DLEtBQVA7QUFBQSxNQUFjQyxRQUFkOztBQUNBNEMsRUFBQUEsR0FBRyxDQUFDN0MsS0FBRCxDQUFILENBQVdDLFFBQVg7QUFDSCIsInNvdXJjZXNDb250ZW50IjpbIi8vIEB0cy1pZ25vcmVcbmltcG9ydCBuZXdyZWxpY0Zvcm1hdHRlciBmcm9tICdAbmV3cmVsaWMvd2luc3Rvbi1lbnJpY2hlcic7XG5pbXBvcnQgd2luc3RvbiwgeyBMb2dnZXIgfSBmcm9tICd3aW5zdG9uJztcbmltcG9ydCB7IHdpdGhDb3JyZWxhdGlvbiB9IGZyb20gJy4vY29ycmVsYXRpb24tbWlkZGxld2FyZSc7XG5pbXBvcnQgeyBOZXdSZWxpY0xvZ1RyYW5zcG9ydCB9IGZyb20gJy4vTmV3UmVsaWNMb2dUcmFuc3BvcnQnO1xuaW1wb3J0IHsgTmV3UmVsaWNMb2dEZWxpdmVyeUFnZW50IH0gZnJvbSAnLi9Mb2dEZWxpdmVyeUFnZW50JztcblxuZXhwb3J0IHR5cGUgS0xMb2dnZXIgPSB3aW5zdG9uLkxvZ2dlclxuZXhwb3J0IHR5cGUgTlBNTG9nZ2luZ0xldmVscyA9ICdzaWxseScgfCAnZGVidWcnIHwgJ3ZlcmJvc2UnIHwgJ2h0dHAnIHwgJ2luZm8nIHwgJ3dhcm4nIHwgJ2Vycm9yJztcbnR5cGUgTG9nU3R5bGUgPSAnU1RSSU5HX0NPTE9SJyB8ICdTVFJJTkcnIHwgJ0pTT04nIHwgJ1NJTEVOVCcgfCAnTkVXX1JFTElDJztcblxuLy8gUXVldWUgZm9yIGxvZ3MgcHJpb3IgdG8gbG9nZ2VyIGNyZWF0aW9uXG5jb25zdCBsb2dTdHlsZXM6IExvZ1N0eWxlW10gPSBbJ1NUUklOR19DT0xPUicsICdTVFJJTkcnLCAnSlNPTicsICdTSUxFTlQnLCAnTkVXX1JFTElDJ107XG5jb25zdCBkZWZhdWx0TG9nU3R5bGU6IExvZ1N0eWxlID0gbG9nU3R5bGVzWzBdO1xuXG5jb25zdCBzdGRvdXRGb3JtYXQgPSB3aW5zdG9uLmZvcm1hdC5wcmludGYoKHsgbGV2ZWwsIG1lc3NhZ2UsIGxhYmVsLCB0aW1lc3RhbXAgfSkgPT4ge1xuICAgIHJldHVybiBgJHt0aW1lc3RhbXB9IFske2xhYmVsfV0gJHtsZXZlbH06ICR7bWVzc2FnZX1gXG59KTtcblxuY29uc3QgY29ycmVsYXRpb25JZEZvcm1hdCA9IHdpbnN0b24uZm9ybWF0KGluZm8gPT4ge1xuICAgIGluZm8uY29ycmVsYXRpb25JZCA9IHdpdGhDb3JyZWxhdGlvbigpO1xuICAgIHJldHVybiBpbmZvO1xufSk7XG5cbmNvbnN0IGdldE5ld1JlbGljTG9nVHJhbnNwb3J0OiAoKSA9PiBOZXdSZWxpY0xvZ1RyYW5zcG9ydCB8IHVuZGVmaW5lZCA9ICgpID0+IHtcbiAgICBtZXNzYWdlcy5wdXNoKFsnc2lsbHknLCAnQXR0ZW1wdGluZyByZXRyaWV2YWwgb2YgTmV3UmVsaWNMb2dEZWxpdmVyeUFnZW50IGluc3RhbmNlJ10pO1xuICAgIGxldCBpbnN0YW5jZSA9IE5ld1JlbGljTG9nRGVsaXZlcnlBZ2VudC5nZXRJbnN0YW5jZSgpO1xuICAgIGlmIChpbnN0YW5jZSkge1xuICAgICAgICByZXR1cm4gaW5zdGFuY2UuZ2V0TG9nVHJhbnNwb3J0KCk7XG4gICAgfVxuICAgIG1lc3NhZ2VzLnB1c2goWydkZWJ1ZycsICdObyBOZXdSZWxpY0xvZ0RlbGl2ZXJ5QWdlbnQgZGVmaW5lZCwgaW5pdGlhbGl6aW5nIGluc3RhbmNlJ10pO1xuICAgIGNvbnN0IHRyYW5zcG9ydCA9IE5ld1JlbGljTG9nRGVsaXZlcnlBZ2VudC5pbml0aWFsaXplKCk/LmdldExvZ1RyYW5zcG9ydCgpO1xuICAgIHRyYW5zcG9ydD8uc2V0TWF4TGlzdGVuZXJzKEluZmluaXR5KTtcbiAgICBtZXNzYWdlcy5wdXNoKFsnc2lsbHknLCBgVHJhbnNwb3J0IGNyZWF0ZWRgXSk7XG4gICAgcmV0dXJuIHRyYW5zcG9ydDtcbn1cblxuY29uc3QgZ2V0TG9nU3R5bGVPcHRpb24gPSAoKTogW0xvZ1N0eWxlLCBzdHJpbmddID0+IHtcbiAgICBpZiAoIXByb2Nlc3MuZW52LkxPR19TVFlMRSkge1xuICAgICAgICByZXR1cm4gW1xuICAgICAgICAgICAgZGVmYXVsdExvZ1N0eWxlLFxuICAgICAgICAgICAgYFVzaW5nIGRlZmF1bHQgbG9nIHN0eWxlOiAke2RlZmF1bHRMb2dTdHlsZX0uIE92ZXJyaWRlIHRoaXMgdXNpbmcgdGhlIExPR19TVFlMRSBlbnZpcm9ubWVudCB2YXJpYWJsZS4gVmFsaWQgdmFsdWVzIGFyZTogJHtsb2dTdHlsZXN9LmBdXG4gICAgfVxuXG4gICAgaWYgKGxvZ1N0eWxlcy5pbmNsdWRlcyhwcm9jZXNzLmVudi5MT0dfU1RZTEUudG9VcHBlckNhc2UoKS50cmltKCkgYXMgTG9nU3R5bGUpKSB7XG4gICAgICAgIHJldHVybiBbXG4gICAgICAgICAgICBwcm9jZXNzLmVudi5MT0dfU1RZTEUgYXMgTG9nU3R5bGUsXG4gICAgICAgICAgICBgVXNpbmcgbG9nIHN0eWxlOiAke3Byb2Nlc3MuZW52LkxPR19TVFlMRX1gXG4gICAgICAgIF07XG4gICAgfVxuXG4gICAgcmV0dXJuIFtcbiAgICAgICAgZGVmYXVsdExvZ1N0eWxlLFxuICAgICAgICBgVW5yZWNvZ25pemVkIGxvZyBzdHlsZTogJHtwcm9jZXNzLmVudi5MT0dfU1RZTEV9LiBVc2luZyBkZWZhdWx0IGxvZyBzdHlsZTogJHtkZWZhdWx0TG9nU3R5bGV9LiBWYWxpZCBsb2cgc3R5bGVzIGFyZTogJHtsb2dTdHlsZXN9YFxuICAgIF1cbn1cblxuY29uc3QgZGVmYXVsdExvZ2dpbmdMZXZlbCA9IHByb2Nlc3MuZW52LkxPR19MRVZFTCA/PyBwcm9jZXNzLmVudi5MRVZFTCA/PyAnZGVidWcnO1xuY29uc3QgbWVzc2FnZXM6IFtOUE1Mb2dnaW5nTGV2ZWxzLCBzdHJpbmddW10gPSBbXTtcbmNvbnN0IFtsb2dTdHlsZSwgbWVzc2FnZV0gPSBnZXRMb2dTdHlsZU9wdGlvbigpO1xubWVzc2FnZXMucHVzaChbJ2luZm8nLCBtZXNzYWdlXSk7XG5leHBvcnQgY29uc3Qgd2l0aExvZ2dlciA9IChsYWJlbDogc3RyaW5nLCBsZXZlbD86IE5QTUxvZ2dpbmdMZXZlbHMpOiBLTExvZ2dlciA9PiB7XG4gICAgc3dpdGNoKGxvZ1N0eWxlKSB7XG4gICAgICAgIGNhc2UgJ0pTT04nOiAgICAgICAgICAgIHJldHVybiBjcmVhdGVKc29uTG9nZ2VyKGxhYmVsLCBsZXZlbCk7XG4gICAgICAgIGNhc2UgJ1NUUklORyc6ICAgICAgICAgIHJldHVybiBjcmVhdGVTdHJpbmdMb2dnZXIobGFiZWwsIGxldmVsKTtcbiAgICAgICAgY2FzZSAnU1RSSU5HX0NPTE9SJzogICAgcmV0dXJuIGNyZWF0ZUNvbG9yU3RyaW5nTG9nZ2VyKGxhYmVsLCBsZXZlbCk7XG4gICAgICAgIGNhc2UgJ1NJTEVOVCc6ICAgICAgICAgIHJldHVybiBjcmVhdGVTaWxlbnRMb2dnZXIobGFiZWwsIGxldmVsKTtcbiAgICAgICAgY2FzZSAnTkVXX1JFTElDJzogICAgICAgcmV0dXJuIGNyZWF0ZU5ld1JlbGljTG9nZ2VyKGxhYmVsLCBsZXZlbCk7XG4gICAgfVxufVxuXG5jb25zdCBjcmVhdGVOZXdSZWxpY0xvZ2dlciA9IChsYWJlbDogc3RyaW5nLCBsZXZlbD86IE5QTUxvZ2dpbmdMZXZlbHMpID0+IHtcbiAgICBpZiAoIXByb2Nlc3MuZW52Lk5FV19SRUxJQ19MSUNFTlNFX0tFWSkge1xuICAgICAgICBtZXNzYWdlcy5wdXNoKFsnd2FybicsICdORVdfUkVMSUMgbG9nZ2luZyBzdHlsZSBjb25maWd1cmVkIGJ1dCBORVdfUkVMSUNfTElDRU5TRV9LRVkgaXMgbm90IGRlZmluZWQhIEZhbGxpbmcgYmFjayB0byBKU09OIGxvZ2dlci4nXSk7XG4gICAgICAgIHJldHVybiBjcmVhdGVKc29uTG9nZ2VyKGxhYmVsLGxldmVsKTtcbiAgICB9XG5cbiAgICByZXR1cm4gd2luc3Rvbi5sb2dnZXJzLmFkZChsYWJlbCwge1xuICAgICAgICBsZXZlbDogbGV2ZWwgPz8gZGVmYXVsdExvZ2dpbmdMZXZlbCxcbiAgICAgICAgZm9ybWF0OiB3aW5zdG9uLmZvcm1hdC5jb21iaW5lKFxuICAgICAgICAgICAgLi4uZGVmYXVsdExvZ2dlcnMobGFiZWwpLFxuICAgICAgICAgICAgbmV3cmVsaWNGb3JtYXR0ZXIoKVxuICAgICAgICApLFxuICAgICAgICB0cmFuc3BvcnRzOiBbIGdldE5ld1JlbGljTG9nVHJhbnNwb3J0KCkgYXMgd2luc3Rvbi50cmFuc3BvcnQgXVxuICAgIH0pO1xufVxuXG5cbmNvbnN0IGNyZWF0ZUpzb25Mb2dnZXIgPSAobGFiZWw6IHN0cmluZywgbGV2ZWw/OiBOUE1Mb2dnaW5nTGV2ZWxzKSA9PiB7XG4gICAgXG4gICAgcmV0dXJuIHdpbnN0b24ubG9nZ2Vycy5hZGQobGFiZWwsIHtcbiAgICAgICAgbGV2ZWw6IGxldmVsID8/IGRlZmF1bHRMb2dnaW5nTGV2ZWwsXG4gICAgICAgIGZvcm1hdDogd2luc3Rvbi5mb3JtYXQuY29tYmluZShcbiAgICAgICAgICAgIC4uLmRlZmF1bHRMb2dnZXJzKGxhYmVsKSxcbiAgICAgICAgICAgIG5ld3JlbGljRm9ybWF0dGVyKClcbiAgICAgICAgKSxcbiAgICAgICAgdHJhbnNwb3J0czogWyBuZXcgd2luc3Rvbi50cmFuc3BvcnRzLkNvbnNvbGUoKSBdXG4gICAgfSk7XG59XG5cbmNvbnN0IGNyZWF0ZVN0cmluZ0xvZ2dlciA9IChsYWJlbDogc3RyaW5nLCBsZXZlbD86IE5QTUxvZ2dpbmdMZXZlbHMpID0+IHtcbiAgICByZXR1cm4gd2luc3Rvbi5sb2dnZXJzLmFkZChsYWJlbCwge1xuICAgICAgICBsZXZlbDogbGV2ZWwgPz8gZGVmYXVsdExvZ2dpbmdMZXZlbCxcbiAgICAgICAgZm9ybWF0OiB3aW5zdG9uLmZvcm1hdC5jb21iaW5lKFxuICAgICAgICAgICAgLi4uZGVmYXVsdExvZ2dlcnMobGFiZWwpLFxuICAgICAgICAgICAgc3Rkb3V0Rm9ybWF0XG4gICAgICAgICksXG4gICAgICAgIHRyYW5zcG9ydHM6IFtcbiAgICAgICAgICAgIG5ldyB3aW5zdG9uLnRyYW5zcG9ydHMuQ29uc29sZSgpXG4gICAgICAgIF1cbiAgICB9KTtcbn1cblxuY29uc3QgY3JlYXRlQ29sb3JTdHJpbmdMb2dnZXIgPSAobGFiZWw6IHN0cmluZywgbGV2ZWw/OiBOUE1Mb2dnaW5nTGV2ZWxzKSA9PiB7XG4gICAgcmV0dXJuIHdpbnN0b24ubG9nZ2Vycy5hZGQobGFiZWwsIHtcbiAgICAgICAgbGV2ZWw6IGxldmVsID8/IGRlZmF1bHRMb2dnaW5nTGV2ZWwsXG4gICAgICAgIGZvcm1hdDogd2luc3Rvbi5mb3JtYXQuY29tYmluZShcbiAgICAgICAgICAgIC4uLmRlZmF1bHRMb2dnZXJzKGxhYmVsKSxcbiAgICAgICAgICAgIHdpbnN0b24uZm9ybWF0LmNvbG9yaXplKCksXG4gICAgICAgICAgICBzdGRvdXRGb3JtYXRcbiAgICAgICAgKSxcbiAgICAgICAgdHJhbnNwb3J0czogW1xuICAgICAgICAgICAgbmV3IHdpbnN0b24udHJhbnNwb3J0cy5Db25zb2xlKClcbiAgICAgICAgXVxuICAgIH0pO1xufVxuXG5jb25zdCBjcmVhdGVTaWxlbnRMb2dnZXIgPSAobGFiZWw6IHN0cmluZywgbGV2ZWw/OiBOUE1Mb2dnaW5nTGV2ZWxzKSA9PiB7XG4gICAgcmV0dXJuIHdpbnN0b24ubG9nZ2Vycy5hZGQobGFiZWwsIHtcbiAgICAgICAgc2lsZW50OiB0cnVlLFxuICAgICAgICBsZXZlbDogbGV2ZWwgPz8gZGVmYXVsdExvZ2dpbmdMZXZlbCxcbiAgICAgICAgdHJhbnNwb3J0czogW1xuICAgICAgICAgICAgbmV3IHdpbnN0b24udHJhbnNwb3J0cy5Db25zb2xlKClcbiAgICAgICAgXVxuICAgIH0pO1xufVxuXG5cbmNvbnN0IGRlZmF1bHRMb2dnZXJzID0gKGxhYmVsOiBzdHJpbmcpOiB3aW5zdG9uLkxvZ2Zvcm0uRm9ybWF0W10gPT4gW1xuICAgIGNvcnJlbGF0aW9uSWRGb3JtYXQoKSxcbiAgICB3aW5zdG9uLmZvcm1hdC5sYWJlbCh7IGxhYmVsIH0pLFxuICAgIHdpbnN0b24uZm9ybWF0LnRpbWVzdGFtcCgpLFxuICAgIHdpbnN0b24uZm9ybWF0LnNwbGF0KCksXG5dIFxuXG5jb25zdCBsb2cgPSB3aXRoTG9nZ2VyKCdsb2dnZXInKTtcbm1lc3NhZ2VzLnB1c2goWydkZWJ1ZycsICdJbnRlcm5hbCBsb2dnZXIgaW5pdGlhbGl6ZWQnXSk7XG53aGlsZShtZXNzYWdlcy5sZW5ndGggPiAwKSB7XG4gICAgY29uc3QgW2xldmVsLCBtZXNzYWdlXSA9IG1lc3NhZ2VzLnNoaWZ0KCkgYXMgW05QTUxvZ2dpbmdMZXZlbHMsIHN0cmluZ107XG4gICAgbG9nW2xldmVsXShtZXNzYWdlKTtcbn1cbiJdfQ==